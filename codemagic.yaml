workflows:
  android-receiver-release:
    name: Android Receiver - Release Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    environment:
      flutter: stable
      vars:
        JAVA_HOME: /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
      groups:
        - supabase_credentials
    
    scripts:
      - name: Fix async_wallpaper namespace issue
        script: |
          set -e
          set -x
          
          echo "Fixing async_wallpaper namespace compatibility..."
          
          # Handle directory structure
          if [ ! -f "pubspec.yaml" ] && [ -d "android_receiver" ]; then
            cd android_receiver
          fi
          
          flutter pub get
          
          WALLPAPER_BUILD_GRADLE="$HOME/.pub-cache/hosted/pub.dev/async_wallpaper-2.1.0/android/build.gradle"
          MANIFEST_FILE="$HOME/.pub-cache/hosted/pub.dev/async_wallpaper-2.1.0/android/src/main/AndroidManifest.xml"
          
          if [ -f "$WALLPAPER_BUILD_GRADLE" ]; then
            echo "Found async_wallpaper build.gradle at: $WALLPAPER_BUILD_GRADLE"
            
            if ! grep -q "namespace" "$WALLPAPER_BUILD_GRADLE"; then
              echo "Adding namespace to async_wallpaper build.gradle..."
              
              # Extract package name (BSD compatible)
              PACKAGE_NAME=$(sed -n 's/.*package="\([^"]*\)".*/\1/p' "$MANIFEST_FILE")
              if [ -z "$PACKAGE_NAME" ]; then
                PACKAGE_NAME="com.example.async_wallpaper"
              fi
              
              echo "Package name: $PACKAGE_NAME"
              
              # Insert namespace (BSD sed requires -i '')
              sed -i '' "/android {/a\\
              namespace '$PACKAGE_NAME'
              " "$WALLPAPER_BUILD_GRADLE"
              
              echo "Namespace added successfully!"
              cat "$WALLPAPER_BUILD_GRADLE"
            else
              echo "Namespace already exists in build.gradle"
            fi
          else
            echo "WARNING: async_wallpaper build.gradle not found at expected location"
          fi
      
      - name: Build release APK
        script: |
          set -e
          set -x
          
          echo "Current directory: $(pwd)"
          ls -la
          
          if [ ! -f "pubspec.yaml" ] && [ -d "android_receiver" ]; then
            echo "Changing directory to android_receiver"
            cd android_receiver
          fi
          
          flutter pub get
          
          flutter clean
          flutter build apk --release
          
          echo "Build finished. APK location:"
          find build/app/outputs -name "*.apk" -type f
          ls -la build/app/outputs/flutter-apk/
          
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
